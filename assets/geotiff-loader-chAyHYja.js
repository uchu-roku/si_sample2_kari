const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/geotiff-4EhtXGWf.js","assets/index-Bmj_S0sl.js","assets/index-D-o8q_NZ.css"])))=>i.map(i=>d[i]);
import{_ as Y,b as j,r as U,s as A,d as _,E as T,e as Q}from"./index-Bmj_S0sl.js";let Z;const tt=()=>Z||=Y(()=>import("./geotiff-4EhtXGWf.js").then(t=>t.g),__vite__mapDeps([0,1,2]));let et;const nt=()=>et||=Y(()=>import("./index-CP7HoFr0.js").then(t=>t.l),[]).then(t=>t.default||t);async function dt(t,{signal:e,forcedCrs:a=null,worldFile:o=null}={}){if(e?.aborted)throw new DOMException("Aborted","AbortError");const{fromArrayBuffer:c,Pool:r}=await tt(),v=await c(t);if(e?.aborted)throw new DOMException("Aborted","AbortError");let x=await v.getImage();try{const n=x.getOverviews?.();n&&n.length&&(x=n[n.length-1])}catch{}if(e?.aborted)throw new DOMException("Aborted","AbortError");const h=2048,B=x.getWidth(),f=x.getHeight(),G=Math.min(1,h/Math.max(B,f)),p=Math.max(1,Math.floor(B*G)),i=Math.max(1,Math.floor(f*G)),O=new r(Math.min(8,navigator.hardwareConcurrency||4)),g=await x.readRasters({interleave:!0,width:p,height:i,resampleMethod:"nearest",pool:O});try{O.terminate?.()}catch{}if(e?.aborted)throw new DOMException("Aborted","AbortError");const b=document.createElement("canvas");b.width=p,b.height=i;const M=b.getContext("2d"),m=new ImageData(p,i);if(g.length===p*i*4)m.data.set(g);else if(g.length===p*i*3){const n=m.data;for(let d=0,w=0;d<g.length;d+=3,w+=4)n[w]=g[d],n[w+1]=g[d+1],n[w+2]=g[d+2],n[w+3]=255}else{const n=m.data;for(let d=0,w=0;d<p*i;d++,w+=4){const E=g[d]??0;n[w]=E,n[w+1]=E,n[w+2]=E,n[w+3]=255}}M.putImageData(m,0,0);const C=await new Promise(n=>b.toBlob(n,"image/png")),D=URL.createObjectURL(C),R=[D],I=()=>{try{R.forEach(n=>URL.revokeObjectURL(n))}catch{}};let u=null;try{u=x.getBoundingBox()}catch{}let l=a;if(!l&&u){const[n,d,w,E]=u,P=Math.max(Math.abs(n),Math.abs(w))<=180&&Math.max(Math.abs(d),Math.abs(E))<=90,S=Math.max(Math.abs(n),Math.abs(w))>180&&Math.max(Math.abs(d),Math.abs(E))>90&&Math.max(Math.abs(n),Math.abs(w))<=2004e4&&Math.max(Math.abs(d),Math.abs(E))<=2004e4;P?l="EPSG:4326":S&&(l="EPSG:3857")}if(!u&&o){const n=at(o);if(n&&Math.abs(n.B)<1e-9&&Math.abs(n.D)<1e-9){const d=n.C,w=n.F,E=d+n.A*p,P=w+n.E*i;u=[d,P,E,w],l=l||"EPSG:4326"}}if(!u||!l)return I(),{ok:!1,reason:"NEED_CRS",suggestion:u?"3857":void 0};let y;if(l==="EPSG:4326"){const[n,d,w,E]=u;y=j.latLngBounds([d,n],[E,w])}else if(l==="EPSG:3857"){const[n,d,w,E]=u,P=await nt(),S=P("EPSG:3857","EPSG:4326",[n,d]),W=P("EPSG:3857","EPSG:4326",[w,E]);y=j.latLngBounds([S[1],S[0]],[W[1],W[0]])}else return I(),{ok:!1,reason:`CRS ${l} is not supported in P1`};const s=j.imageOverlay(D,y,{opacity:.9,pane:"overlayPane"});return queueMicrotask(async()=>{try{const n=await v.getImage(),d=n.getWidth(),w=n.getHeight(),E=new r(Math.min(8,navigator.hardwareConcurrency||4)),P=await n.readRasters({interleave:!0,pool:E});try{E.terminate?.()}catch{}const S=document.createElement("canvas");S.width=d,S.height=w;const W=S.getContext("2d"),k=new ImageData(d,w);if(P.length===d*w*4)k.data.set(P);else if(P.length===d*w*3){const L=k.data;for(let N=0,F=0;N<P.length;N+=3,F+=4)L[F]=P[N],L[F+1]=P[N+1],L[F+2]=P[N+2],L[F+3]=255}else{const L=k.data;for(let N=0,F=0;N<d*w;N++,F+=4){const K=P[N]??0;L[F]=K,L[F+1]=K,L[F+2]=K,L[F+3]=255}}W.putImageData(k,0,0);const J=await new Promise(L=>S.toBlob(L,"image/png")),z=URL.createObjectURL(J);try{R.push(z)}catch{}try{s.setUrl(z)}catch{}try{URL.revokeObjectURL(D)}catch{}}catch(n){console.warn("[GeoTIFF] full-res swap failed:",n)}}),{ok:!0,layer:s,bounds:y,revoke:I}}function at(t){try{const e=(t||"").trim().split(/\r?\n/).map(h=>parseFloat(h.trim()));if(e.length<6||e.some(h=>Number.isNaN(h)))return null;const[a,o,c,r,v,x]=e;return{A:a,D:o,B:c,E:r,C:v,F:x}}catch{return null}}function $(t){let e=1/0,a=-1/0;for(let c=0;c<t.length;c++){const r=t[c];Number.isFinite(r)&&(r<e&&(e=r),r>a&&(a=r))}(!Number.isFinite(e)||!Number.isFinite(a)||e===a)&&(e=0,a=1);const o=a-e||1;return function(c){if(!Number.isFinite(c))return 0;const r=(c-e)/o*255;return r<0?0:r>255?255:r}}async function ot(t){if(typeof t.getOverviews=="function"){const e=await t.getOverviews();return e&&e.length?e[e.length-1]:t}if(typeof t.getOverviewCount=="function"&&typeof t.getOverview=="function"){const e=t.getOverviewCount();return e&&e>0?t.getOverview(e-1):t}return t}async function V(t,e={}){const{useOverview:a=!1,previewMaxPixels:o=1e6,window:c=null}=e;let r=t;try{const u=t.getWidth(),l=t.getHeight(),y=typeof t.getOverviews=="function"&&t.getOverviews().length>0;if((a||u*l>o)&&y){const s=t.getOverviews();r=s[s.length-1],U({phase:"overview-picked",size:[r.getWidth(),r.getHeight()]},"info")}}catch{}const v={interleave:!0};c&&Array.isArray(c)&&c.length===4&&(v.window=c);const x=await A("geotiff.readRasters",()=>r.readRasters(v)),h=r.getWidth(),B=r.getHeight(),f=r.getSamplesPerPixel?.()??r.fileDirectory?.SamplesPerPixel??1,G=r.getBitsPerSample?.()??r.fileDirectory?.BitsPerSample??[8],p=Array.isArray(G)?G.every(u=>u===8):G===8,i=x,O=h*B,g=!p||!(i instanceof Uint8Array||i instanceof Uint8ClampedArray);function b(u){if(!g)return{min:0,max:255};let l=1/0,y=-1/0;for(let s=u;s<i.length;s+=f){const n=i[s];n<l&&(l=n),n>y&&(y=n)}return l===y&&(l=0,y=1),{min:l,max:y}}const M=Array.from({length:f},(u,l)=>b(l)),m=new Uint8ClampedArray(O*4);if(f===4)for(let u=0,l=0;u<O;u++,l+=4)for(let y=0;y<4;y++){const{min:s,max:n}=M[y],d=i[l+y];m[u*4+y]=g?(d-s)*255/(n-s):d}else if(f===3){const u=M[0],l=M[1],y=M[2];for(let s=0,n=0;s<O;s++,n+=3)m[s*4]=g?(i[n]-u.min)*255/(u.max-u.min):i[n],m[s*4+1]=g?(i[n+1]-l.min)*255/(l.max-l.min):i[n+1],m[s*4+2]=g?(i[n+2]-y.min)*255/(y.max-y.min):i[n+2],m[s*4+3]=255}else if(f===2){const u=M[0],l=M[1];for(let y=0,s=0;y<O;y++,s+=2){const n=g?(i[s]-u.min)*255/(u.max-u.min):i[s],d=g?(i[s+1]-l.min)*255/(l.max-l.min):i[s+1];m[y*4]=m[y*4+1]=m[y*4+2]=n,m[y*4+3]=d}}else if(f===1){const u=M[0];for(let l=0;l<O;l++){const y=g?(i[l]-u.min)*255/(u.max-u.min):i[l];m[l*4]=m[l*4+1]=m[l*4+2]=y,m[l*4+3]=255}}else{const u=M[0]??{min:0,max:255},l=M[1]??u,y=M[2]??l;for(let s=0,n=0;s<O;s++,n+=f)m[s*4]=g?(i[n]-u.min)*255/(u.max-u.min):i[n],m[s*4+1]=g?(i[n+1]-l.min)*255/(l.max-l.min):i[n+1],m[s*4+2]=g?(i[n+2]-y.min)*255/(y.max-y.min):i[n+2],m[s*4+3]=255}const C=document.createElement("canvas");C.width=h,C.height=B;const D=C.getContext("2d",{willReadFrequently:!1}),R=new ImageData(m,h,B);D.putImageData(R,0,0);const I=await new Promise(u=>C.toBlob(u,"image/png"));return URL.createObjectURL(I)}const ht=V;async function mt(t){const e=t.name.split(".").pop().toLowerCase();switch(e){case"tif":case"tiff":case"geotiff":return await q(t);case"gpkg":return await rt(t);case"shp":return await st(t);default:throw new Error(`„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„Éï„Ç°„Ç§„É´ÂΩ¢Âºè: ${e}`)}}async function q(t){try{const e=await A("read.arrayBuffer",async()=>{if(t instanceof ArrayBuffer)return t;if(t instanceof Blob)return await t.arrayBuffer();if(t?.buffer instanceof ArrayBuffer)return t.buffer;throw _(T.GEO_OPEN,"„Çµ„Éù„Éº„Éà„Åï„Çå„Å™„ÅÑÂÖ•ÂäõÂûã„Åß„Åô",{type:Object.prototype.toString.call(t)})});console.info("buffer bytes:",e.byteLength.toLocaleString());const a=await A("geotiff.fromArrayBuffer",async()=>{try{return await fromArrayBuffer(e)}catch(f){throw _(T.GEO_PARSE,"geotiff.fromArrayBuffer() „Å´Â§±Êïó",{size:e.byteLength},f)}}),o=await A("geotiff.getImage",async()=>{try{return await a.getImage()}catch(f){throw _(T.GEO_GET_IMAGE,"getImage() „Å´Â§±Êïó",{},f)}}),c={width:o.getWidth?.(),height:o.getHeight?.(),bbox:o.getBoundingBox?.(),srs:o.getGeoKeys?.(),samples:o.getSamplesPerPixel?.(),bits:o.getBitsPerSample?.(),planar:o.getPlanarConfiguration?.(),hasOverviews:typeof o.getOverviews=="function"};console.groupCollapsed("‚ÑπÔ∏è GeoTIFF image info"),console.table(c),console.groupEnd();const r=await A("geotiff.pickOverview",async()=>{try{if(typeof o.getOverviews=="function"){const f=await o.getOverviews();if(console.info("overview count:",f?.length||0),f&&f.length)return f[0]}return o}catch(f){throw _(T.GEO_PICK_OV,"„Ç™„Éº„Éê„Éº„Éì„É•„ÉºÂèñÂæó„Å´Â§±Êïó",{},f)}}),v=await A("geotiff.readRasters",async()=>{try{return await r.readRasters({interleave:!1})}catch(f){throw _(T.GEO_RASTERS,"readRasters() „Å´Â§±Êïó",{width:r.getWidth?.(),height:r.getHeight?.(),samples:r.getSamplesPerPixel?.()},f)}}),x=Array.from(v).slice(0,3).map((f,G)=>({band:G,...Q(f)}));console.groupCollapsed("üìà raster stats (first 3 bands)"),console.table(x),console.groupEnd();const{url:h,bounds:B}=await A("render.rgbaToBlobUrl",async()=>await V(r,v));return{url:h,bounds:B}}catch(e){throw U(e),e}}async function wt(t){try{const e=await fromArrayBuffer(t),a=await e.getImage(),o=a.getFileDirectory(),c=a.getGeoKeys(),r=await ot(a),v={interleave:!1};if(r===a&&typeof a.getWidth=="function"){const G=a.getWidth(),p=a.getHeight(),i=4096;Math.max(G,p)>i&&(G>=p?v.width=i:v.height=i)}const x=await r.readRasters(v),{dataUrl:h,boundsLatLng:B}=await it(x,a,r.getWidth(),r.getHeight());let f=[];try{if(typeof a.getOverviews=="function")f=(await a.getOverviews()).map(p=>({width:p.getWidth(),height:p.getHeight(),scale:a.getWidth()/p.getWidth()}));else if(typeof a.getOverviewCount=="function"&&typeof a.getOverview=="function"){const G=a.getOverviewCount();for(let p=0;p<G;p++){const i=await a.getOverview(p);f.push({width:i.getWidth(),height:i.getHeight(),scale:a.getWidth()/i.getWidth()})}}}catch(G){console.warn("„Ç™„Éº„Éê„Éº„Éì„É•„ÉºÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:",G),f=[]}return{type:"geotiff",tiff:e,image:a,metadata:o,geoKeys:c,imageData:x,width:r.getWidth(),height:r.getHeight(),bbox:r.getBoundingBox(),boundsLatLng:B,overviews:f,isCog:f.length>0,dataUrl:h}}catch(e){throw console.error("GeoTIFF„ÅÆË™≠„ÅøËæº„Åø„Ç®„É©„Éº:",e),e}}async function rt(t){try{const e=await t.arrayBuffer();return{type:"geopackage",fileName:t.name,fileSize:t.size}}catch(e){throw console.error("GeoPackage„ÅÆË™≠„ÅøËæº„Åø„Ç®„É©„Éº:",e),e}}async function st(t){try{const e=await t.arrayBuffer();return{type:"shapefile",fileName:t.name,fileSize:t.size}}catch(e){throw console.error("Shapefile„ÅÆË™≠„ÅøËæº„Åø„Ç®„É©„Éº:",e),e}}async function yt(t,e={}){try{const a=await t.getImage(e),o=await a.readRasters(e);return{image:a,imageData:o,width:a.getWidth(),height:a.getHeight(),bbox:a.getBoundingBox()}}catch(a){throw console.error("COGÁØÑÂõ≤Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº:",a),a}}function pt(t,e){if(!t||t.length===0)return null;let a=t[0],o=Math.abs(e-a.scale);for(let c=1;c<t.length;c++){const r=Math.abs(e-t[c].scale);r<o&&(o=r,a=t[c])}return a}async function bt(t){const{width:e,height:a,imageData:o,image:c}=t,r=document.createElement("canvas");r.width=e,r.height=a;const v=r.getContext("2d");if(o&&o.length)if(o.length===1){const x=o[0],h=v.createImageData(e,a),B=c.getGDALNoData?await c.getGDALNoData():void 0,f=B!=null&&B!==""?Number(B):void 0,G=$(x);for(let p=0;p<x.length;p++){const i=x[p],O=p<<2;if(f!==void 0&&Number.isFinite(f)&&i===f){h.data[O+3]=0;continue}const g=G(i)|0;h.data[O]=h.data[O+1]=h.data[O+2]=g,h.data[O+3]=255}v.putImageData(h,0,0)}else{const x=o[0],h=o[1],B=o[2],f=o[3],G=o.length===4,p=c.getGDALNoData?await c.getGDALNoData():void 0,i=p!=null&&p!==""?Number(p):void 0,O=x.length,g=v.createImageData(e,a);for(let b=0;b<O;b++){const M=b<<2;if(i!==void 0&&Number.isFinite(i)&&(x[b]===i||h[b]===i||B[b]===i)){g.data[M+3]=0;continue}g.data[M]=x[b],g.data[M+1]=h[b],g.data[M+2]=B[b],g.data[M+3]=G?f[b]:255}v.putImageData(g,0,0)}else v.fillStyle="#8bc34a",v.fillRect(0,0,e,a);return r}async function it(t,e,a,o){const c=document.createElement("canvas");c.width=a,c.height=o;const r=c.getContext("2d");if(t&&t.length)if(t.length===1){const g=t[0],b=r.createImageData(a,o),M=e.getGDALNoData?await e.getGDALNoData():void 0,m=M!=null&&M!==""?Number(M):void 0,C=$(g);for(let D=0;D<g.length;D++){const R=g[D],I=D<<2;if(m!==void 0&&Number.isFinite(m)&&R===m){b.data[I+3]=0;continue}const u=C(R)|0;b.data[I]=b.data[I+1]=b.data[I+2]=u,b.data[I+3]=255}r.putImageData(b,0,0)}else{t[0],t[1],t[2];const g=e.getGDALNoData?await e.getGDALNoData():void 0,b=g!=null&&g!==""?Number(g):void 0,M=a*o,m=new Uint8ClampedArray(M*4),C=Number.isFinite(b),D=bands.length===1?bands[0]:null;let R=null;if(D){let s=1/0,n=-1/0;for(let w=0;w<M;w++){const E=D[w];Number.isFinite(E)&&(E<s&&(s=E),E>n&&(n=E))}const d=n>s?255/(n-s):1;R=w=>Math.max(0,Math.min(255,Math.round((w-s)*d))),console.info(`GeoTIFF 1„Éê„É≥„Éâ„ÅÆÂèØË¶ñÂåñ: min=${s}, max=${n}`)}for(let s=0;s<M;s++){const n=s<<2;if(C){let d=!0;for(let w=0;w<bands.length;w++)if(bands[w][s]!==b){d=!1;break}if(d){m[n+3]=0;continue}}if(bands.length===1){const d=R?R(D[s]):D[s]&255;m[n]=d,m[n+1]=d,m[n+2]=d,m[n+3]=255}else m[n]=bands[0][s]&255,m[n+1]=bands[1][s]&255,m[n+2]=bands[2][s]&255,m[n+3]=255}const I=document.createElement("canvas");I.width=a,I.height=o,I.getContext("2d").putImageData(new ImageData(m,a,o),0,0);const l=await new Promise(s=>I.toBlob(s));return{url:URL.createObjectURL(l),width:a,height:o,bounds}}else r.fillStyle="#8bc34a",r.fillRect(0,0,a,o);const v=r.getImageData(0,0,a,o),x=new ImageData(v.data,a,o),h=document.createElement("canvas");h.width=a,h.height=o,h.getContext("2d").putImageData(x,0,0);const f=8192;let G=h;if(Math.max(a,o)>f){const g=f/Math.max(a,o),b=document.createElement("canvas");b.width=Math.round(a*g),b.height=Math.round(o*g),b.getContext("2d").drawImage(h,0,0,b.width,b.height),G=b}const p=await new Promise(g=>G.toBlob(g,"image/png",.92)),i=URL.createObjectURL(p),O=lt(e);return{dataUrl:i,boundsLatLng:O}}const X=6378137;function H(t,e){const a=t/X*180/Math.PI,o=(2*Math.atan(Math.exp(e/X))-Math.PI/2)*180/Math.PI,c=85.05112878;return[a,Math.max(Math.min(o,c),-c)]}function ct([t,e,a,o]){return Math.abs(t)>180||Math.abs(a)>180||Math.abs(e)>90||Math.abs(o)>90}function ft(t,e){let a,o;if(e===3857||!e&&ct(t)){const[c,r]=H(t[0],t[1]),[v,x]=H(t[2],t[3]);a=[r,c],o=[x,v]}else a=[t[1],t[0]],o=[t[3],t[2]];return j.latLngBounds(a,o)}function lt(t){let e,a,o,c;if(typeof t.getBoundingBox=="function")[e,a,o,c]=t.getBoundingBox();else{const h=t.getTiePoints()[0],B=t.getFileDirectory().ModelPixelScale,f=t.getWidth(),G=t.getHeight();e=h.x,c=h.y,o=e+f*B[0],a=c-G*B[1]}let r;const v=typeof t.getGeoKeys=="function"?t.getGeoKeys():{};if(v.ProjectedCSTypeGeoKey===3857||v.ProjectedCSTypeGeoKey===900913){const h=H(e,a),B=H(o,c);r=[[h[1],h[0]],[B[1],B[0]]]}else r=[[a,e],[c,o]];return r}async function vt(t){try{return await A(`File selected: ${t.name} (${t.size} bytes)`,async()=>{const e=await A("Read as ArrayBuffer",()=>t.arrayBuffer()),a=await A("geotiff.fromArrayBuffer",()=>fromArrayBuffer(e)),o=await A("tiff.getImage(0)",()=>a.getImage(0)),c=await A("image.getBoundingBox",()=>o.getBoundingBox()),r=o.getGeoKeys&&o.getGeoKeys()||{},v=r.ProjectedCSTypeGeoKey||r.GeographicTypeGeoKey||void 0,x=o.getWidth(),h=o.getHeight(),B=o.getGeoKeys?.()||{},f=B.ProjectedCSTypeGeoKey||B.GeographicTypeGeoKey||"unknown";U({phase:"image-meta",width:x,height:h,bbox:c,epsg:f}),[4326,3857].includes(Number(f))||U(_(T.GEO_RENDER,"ÊÉ≥ÂÆöÂ§ñ„ÅÆÂ∫ßÊ®ôÁ≥ª„ÅÆÂèØËÉΩÊÄß",{epsg:f}),"warn");const G=ft(c,v),{url:p}=await A("Render raster overlay",async()=>await gt(e));return{url:p,bounds:G}})}catch(e){throw U(_(T.GEO_PARSE,"GeoTIFF Ë™≠„ÅøËæº„Åø„Å´Â§±Êïó",{file:t.name},e)),e}}async function gt(t){return await q(t)}export{bt as createCanvasFromGeoTIFF,V as default,yt as loadCOGRange,mt as loadFile,rt as loadGeoPackage,q as loadGeoTIFF,wt as loadGeoTIFFFromArrayBuffer,vt as loadGeoTIFFWithSteps,dt as loadGeoTiffAsOverlay,st as loadShapefile,ht as makeRgbaBlobUrl,V as rgbaToBlobUrl,pt as selectOverviewByResolution};
//# sourceMappingURL=geotiff-loader-chAyHYja.js.map
